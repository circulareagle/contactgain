<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NaijaPro Contact Gain</title>
    <meta property="og:image" content="https://vcf.circulareagle.com/social-share-image.jpg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        
        :root {
            --primary: #059669;
            --primary-dark: #064e3b;
            --vcf-red: #ef4444;
            --vcf-grey: #94a3b8;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            background-color: #f8fafc;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        
        @keyframes slideUp { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .nav-item.active { color: var(--primary); }
        .nav-item.active i { transform: translateY(-4px); transition: transform 0.3s ease; }
        
        .input-focus:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(5, 150, 105, 0.1);
        }
        
        #custom-alert, #whatsapp-promo, #verify-modal { display: none; }

        /* Pipeline Styles */
        .pipeline-container {
            width: 100%;
            height: 12px;
            background: #e2e8f0;
            border-radius: 999px;
            position: relative;
            overflow: hidden;
            border: 1px solid #cbd5e1;
        }
        .pipeline-fill {
            height: 100%;
            transition: width 0.8s ease-in-out;
            background: repeating-linear-gradient(
                45deg,
                var(--vcf-red),
                var(--vcf-red) 10px,
                #dc2626 10px,
                #dc2626 20px
            );
        }
        .pipeline-empty {
            background: #cbd5e1 !important;
        }

        /* Scan Line Animation for Verification Modal */
        #scan-line {
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #22c55e, transparent);
            position: absolute;
            top: 0;
        }
        .scan-active #scan-line {
             animation: scan 6s infinite linear alternate;
        }
        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }
    </style>
</head>
<body class="text-slate-900 pb-28">

    <!-- Premium Header -->
    <header class="bg-white border-b border-slate-100 p-5 sticky top-0 z-40">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-800 tracking-tight text-emerald-900 flex items-center gap-2">
                    <span class="bg-emerald-600 text-white p-1 rounded-lg"><i data-lucide="briefcase" class="w-5 h-5"></i></span>
                    NaijaPro Contact Gain
                </h1>
                <p class="text-[10px] font-bold text-emerald-600/60 uppercase tracking-widest mt-1">Commercial Networking Only</p>
            </div>
            <!-- User Status now shows User ID and Member status -->
            <div id="user-status" class="flex gap-2 items-center">
                 <span class="h-2 w-2 bg-slate-300 rounded-full"></span>
                 <span id="auth-status-text" class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Guest</span>
            </div>
        </div>
        <div id="user-id-display" class="text-xs font-mono text-slate-400 mt-2 text-center break-all">
            Loading User ID...
        </div>
    </header>

    <!-- Alert Modal -->
    <div id="custom-alert" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-slate-900/40 backdrop-blur-md">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl">
            <div id="alert-icon" class="mb-4 text-center"></div>
            <h3 id="alert-title" class="text-xl font-bold text-slate-900 mb-2 text-center">Notice</h3>
            <p id="alert-message" class="text-sm text-slate-600 mb-8 leading-relaxed text-center"></p>
            <button onclick="closeAlert()" class="w-full bg-emerald-600 text-white font-bold py-4 rounded-2xl transition-all active:scale-95 shadow-lg shadow-emerald-200">Got it!</button>
        </div>
    </div>

    <!-- WhatsApp Channel Promo Modal -->
    <div id="whatsapp-promo" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-slate-900/60 backdrop-blur-md">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl text-center">
            <div class="bg-emerald-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="bell" class="text-emerald-600 w-8 h-8"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-900 mb-2">Stay Updated!</h3>
            <p class="text-sm text-slate-600 mb-8 leading-relaxed">Join our Official WhatsApp Channel to get instant notifications whenever new VCF batches are uploaded.</p>
            <div class="space-y-3">
                <a href="https://whatsapp.com/channel/0029VbC3ITpHVvTZ5btPTn0h" target="_blank" onclick="closePromo()" class="block w-full bg-emerald-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-emerald-200">Join Channel Now</a>
                <button onclick="closePromo()" class="w-full text-slate-400 font-bold py-2 text-sm">Maybe Later</button>
            </div>
        </div>
    </div>

    <!-- Sincerity Bot Verification Modal (Now a WAITING modal) -->
    <div id="verify-modal" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-slate-900/80 backdrop-blur-xl">
        <div id="verification-card" class="bg-white rounded-3xl p-6 max-w-sm w-full shadow-2xl relative overflow-hidden transition-all duration-300">
            <div id="scan-line-container" class="absolute inset-0 z-0 opacity-10">
                <div id="scan-line" class="absolute top-0 left-0 right-0 h-[3px] bg-emerald-500 shadow-lg"></div>
            </div>
            
            <div class="relative z-10">
                <div class="bg-slate-50 p-4 rounded-2xl flex items-center justify-center mx-auto mb-4 w-16 h-16">
                    <i data-lucide="shield-half" class="text-emerald-600 w-8 h-8"></i>
                </div>
                <h3 id="verification-title" class="text-xl font-bold text-slate-900 mb-1 text-center">Initiating Verification...</h3>
                <p id="verification-subtitle" class="text-xs text-slate-500 mb-6 leading-relaxed text-center">
                    Please complete the WhatsApp share and return to this page.
                </p>

                <!-- Status Panel (Integrated from previous example) -->
                 <div id="status-panel" class="p-4 rounded-xl border border-dashed border-indigo-300 mb-6 transition-all duration-300">
                    <div class="flex items-center space-x-3">
                        <svg id="status-icon" class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                        <p id="status-message" class="text-sm font-semibold text-gray-800">Waiting for app to lose focus...</p>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-2">Min required task time: <span class="font-bold">6 seconds</span>.</p>
                </div>

                <p id="verification-footer" class="text-xs text-center text-slate-500/80 font-medium">
                    Do not close the browser or minimize this app until verification is complete.
                </p>
            </div>
        </div>
    </div>

    <main class="max-w-md mx-auto p-5">
        
        <!-- REGISTRATION SECTION -->
        <section id="tab-home" class="tab-content active space-y-6">
            <div id="member-view" class="hidden space-y-6">
                <div class="bg-emerald-600 rounded-3xl p-8 text-white shadow-xl">
                    <h2 class="text-2xl font-bold">Welcome Back!</h2>
                    <p class="text-sm opacity-90 mt-2">You are a verified member. Access your 10 VCF files below.</p>
                    <div class="mt-6">
                         <button onclick="handleGoToFiles()" class="w-full bg-white text-emerald-700 font-bold py-4 rounded-2xl flex items-center justify-center gap-2 active:scale-[0.98] transition-all">
                            <i data-lucide="file-down" class="w-5 h-5"></i> Go to VCF Files
                        </button>
                    </div>
                </div>
            </div>

            <div id="guest-view" class="space-y-6">
                <div class="bg-emerald-50 border border-emerald-100 p-5 rounded-3xl">
                    <div class="flex gap-4">
                        <div class="bg-white p-2 h-fit rounded-xl shadow-sm">
                            <i data-lucide="lock" class="text-emerald-600 w-5 h-5"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-emerald-900 text-sm">Restricted Access</h3>
                            <p class="text-xs text-emerald-800/70 leading-relaxed mt-1">
                                Join the directory to unlock the 10-batch VCF networking files.
                            </p>
                        </div>
                    </div>
                </div>

                <div id="form-container" class="bg-white rounded-3xl shadow-sm p-6 border border-slate-100">
                    <div class="mb-6">
                        <h2 class="text-xl font-bold text-slate-800">Register Your Business</h2>
                        <p class="text-xs text-slate-400 mt-1">Join thousands of Nigerian professionals.</p>
                    </div>
                  
                    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;" onload="if(submitted){handleSuccess();}"></iframe>
                    
                    <!-- NOTE: Form action is preserved as requested -->
                    <form id="registration-form" class="space-y-5" 
                          action="https://docs.google.com/forms/d/e/1FAIpQLSc1Yz0jF5wANDrrZe_DgU5yMx6cWX_2BgzI8gNUHQUTe4XQCQ/formResponse" 
                          method="POST" 
                          target="hidden_iframe"
                          onsubmit="submitted=true;">
                        <div>
                            <label class="block text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-2 ml-1">Business/Brand Name</label>
                            <input required type="text" name="entry.403300635" placeholder="e.g. Lagos Tech Hub" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none transition-all input-focus text-sm">
                        </div>
                        <div>
                            <label class="block text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-2 ml-1">WhatsApp Business Number</label>
                            <input required type="tel" name="entry.1493637334" placeholder="0801 234 5678" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none transition-all input-focus text-sm">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-2 ml-1">Category</label>
                                <select required name="entry.50410248" id="category-select" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl text-sm outline-none input-focus appearance-none">
                                    <option value="">Select Industry</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-2 ml-1">Location</label>
                                <select required name="entry.1635387367" id="state-select" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl text-sm outline-none input-focus appearance-none">
                                    <option value="">Select State</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-emerald-600 text-white font-bold py-5 rounded-2xl hover:bg-emerald-700 shadow-xl shadow-emerald-100 active:scale-[0.98] transition-all flex items-center justify-center gap-2 text-sm uppercase">
                            JOIN & UNLOCK FILES
                        </button>
                    </form>
                </div>
            </div>

            <div id="success-container" class="hidden space-y-6">
                <div class="bg-white rounded-3xl shadow-xl p-8 text-center border border-emerald-50">
                    <div class="bg-emerald-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="party-popper" class="text-emerald-600 w-10 h-10"></i>
                    </div>
                    <h2 class="text-2xl font-800 text-slate-800">Registration Complete!</h2>
                    <p class="text-sm text-slate-500 mt-2 leading-relaxed">Access the VCF files and complete the share task to download.</p>
                    <div class="mt-8">
                        <button onclick="handleGoToFiles()" class="w-full bg-emerald-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-emerald-100 flex items-center justify-center gap-2 active:scale-[0.98] transition-all">
                            <i data-lucide="download-cloud" class="w-5 h-5"></i> Access VCF Files
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- DOWNLOADS TAB -->
        <section id="tab-download" class="tab-content space-y-5">
            <div id="download-locked" class="py-12 text-center space-y-4">
                <div class="bg-slate-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto">
                    <i data-lucide="lock" class="text-slate-400 w-8 h-8"></i>
                </div>
                <h3 class="font-bold text-slate-800">Files Locked</h3>
                <p class="text-xs text-slate-500 px-10">Please register your business on the Home tab to access these files.</p>
                <button onclick="switchTab('home')" class="text-emerald-600 font-bold text-sm uppercase tracking-widest">Go to Home</button>
            </div>

            <div id="download-unlocked" class="hidden space-y-5">
                <div class="px-2 flex justify-between items-end">
                    <div>
                        <div class="flex items-center gap-2 text-emerald-600 mb-1">
                            <i data-lucide="check-circle-2" class="w-4 h-4"></i>
                            <span class="text-[10px] font-bold uppercase tracking-widest">Verified Member Access</span>
                        </div>
                        <h2 class="text-2xl font-800 text-slate-900 tracking-tight">Active Directories</h2>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Last Update</p>
                        <p id="update-date" class="text-xs font-bold text-emerald-600">Jan 9, 2026</p>
                    </div>
                </div>
                
                <!-- 10 VCF FILE LIST -->
                <div id="vcf-list" class="space-y-4">
                    <!-- Cards generated by JS -->
                </div>

                <div class="bg-blue-50 border border-blue-100 p-5 rounded-3xl flex flex-col gap-3">
                    <div class="flex gap-4">
                        <i data-lucide="info" class="text-blue-600 shrink-0"></i>
                        <p class="text-xs text-blue-800/80 leading-relaxed">
                            A new batch of vendors is added every 24-48 hours. 
                            <a href="https://whatsapp.com/channel/0029VbC3ITpHVvTZ5btPTn0h" target="_blank" class="text-blue-700 font-bold underline">Join our Official WhatsApp Channel</a> 
                            for files upload updates without re-registering.
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- SAFETY TAB (LOGS ADDED HERE) -->
        <section id="tab-safety" class="tab-content space-y-6">
            <div class="bg-slate-900 p-6 rounded-3xl text-white shadow-xl">
                <h2 class="text-xl font-bold flex items-center gap-2"><i data-lucide="shield"></i> Safety & Ethics</h2>
                <p class="text-xs opacity-90 mt-2">Protect your account and your business.</p>
            </div>
            
            <!-- Sincerity Bot Audit Log (New Section) -->
            <div id="verification-log-card" class="bg-white p-6 rounded-3xl border border-red-500/10 space-y-4 shadow-lg">
                <h3 class="text-lg font-bold text-red-600 flex items-center gap-2">
                    <i data-lucide="eye-off" class="w-5 h-5"></i> Sincerity Bot Audit Log
                </h3>
                <p class="text-xs text-slate-500">
                    Tracks verification attempts and cross-platform timing for compliance (Min <span class="font-bold text-red-500">6s</span> required).
                </p>
                <div id="log-container" class="space-y-3 max-h-60 overflow-y-auto p-3 bg-gray-50 border border-gray-200 rounded-lg">
                    <p class="text-gray-400 text-sm">Waiting for real-time logs...</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-3xl border border-slate-100 space-y-5">
                <div class="flex gap-4">
                    <div class="bg-blue-50 p-2 rounded-xl"><i data-lucide="key" class="text-blue-600 w-5 h-5"></i></div>
                    <div>
                        <h4 class="text-sm font-bold text-slate-800">Enable 2FA</h4>
                        <p class="text-xs text-slate-500 mt-1">Always keep 2-Step verification active on your WhatsApp.</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-xl border-t border-slate-100 flex justify-around items-center h-20 px-10 z-50 pb-2">
        <button onclick="switchTab('home')" class="nav-item active flex flex-col items-center gap-1" data-tab="home">
            <i data-lucide="home" class="w-6 h-6"></i>
            <span class="text-[10px] font-800 uppercase">Home</span>
        </button>
        <button onclick="switchTab('download')" class="nav-item flex flex-col items-center gap-1" data-tab="download">
            <i data-lucide="layers" class="w-6 h-6"></i>
            <span class="text-[10px] font-800 uppercase">Files</span>
        </button>
        <button onclick="switchTab('safety')" class="nav-item flex flex-col items-center gap-1" data-tab="safety">
            <i data-lucide="shield-check" class="w-6 h-6"></i>
            <span class="text-[10px] font-800 uppercase">Safety</span>
        </button>
    </nav>

    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, orderBy, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ENVIRONMENT VARIABLES (Mandatory for Canvas) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- CONFIGURABLE DATA & STATE ---
        const MIN_VERIFICATION_SECONDS = 6; // Mandatory minimum time user must be away
        let timeAppLostFocus = null; // Timestamp when visibility became 'hidden'
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        const CONFIG = {
            updateDate: "Updated Today, 11:45 PM",
            shareTargetUnlock: 3, // Shares needed to unlock the file
            shareTargetPostDownload: 4, // Shares needed for the 'locked for tomorrow' message
            shareText: "Grow your business contacts for free on NaijaPro! Register and get the latest VCF batches here: " + window.location.href,
            vcfData: [
                { id: 1, count: 842, status: "Ongoing", file: "NaijaPro_Batch_1.vcf" },
                { id: 2, count: 0, status: "Not yet activated", file: "NaijaPro_Batch_2.vcf" },
                { id: 3, count: 0, status: "Not yet activated", file: "NaijaPro_Batch_3.vcf" },
                { id: 4, count: 0, status: "Not yet activated", file: "NaijaPro_Batch_4.vcf" },
                { id: 5, count: 0, status: "Not yet activated", file: "NaijaPro_Batch_5.vcf" },
                { id: 6, count: 0, status: "Not yet activated", file: "NaijaPro_Batch_6.vcf" },
                { id: 7, count: 0, status: "Not yet activated", file: "NaijaPro_Batch_7.vcf" },
                { id: 8, count: 0, status: "Not yet activated", file: "NaijaPro_Batch_8.vcf" },
                { id: 9, count: 0, status: "Not yet activated", file: "NaijaPro_Batch_9.vcf" },
                { id: 10, count: 0, status: "Not yet activated", file: "NaijaPro_Batch_10.vcf" }
            ]
        };

        // --- PERSISTENCE KEYS (Still using localStorage for client-side app data) ---
        const IS_REGISTERED_KEY = 'naijapro_user_registered';
        const TASK_PROGRESS_KEY = 'naijapro_task_progress';
        const DOWNLOADED_HISTORY_KEY = 'naijapro_downloaded_history';

        let submitted = false;
        let currentVcfId = null; // Used to track which VCF file is being unlocked
        let isVerificationAttempting = false; // Prevents logging spam

        const categories = ["Fashion & Lifestyle", "Gadgets & Electronics", "Real Estate", "Beauty & Skincare", "Logistics & Delivery", "Digital Assets/Crypto", "Automobiles", "Food & Groceries", "Interior Decor", "Education", "Consultancy", "Others"];
        const states = ["Lagos", "Abuja (FCT)", "Rivers", "Oyo", "Kano", "Ogun", "Enugu", "Delta", "Anambra", "Edo", "R.S", "Adamawa", "Akwa Ibom", "Bauchi", "Bayelsa", "Benue", "Borno", "Cross River", "Ebonyi", "Ekiti", "Gombe", "Imo", "Jigawa", "Kaduna", "Katsina", "Kebbi", "Kogi", "Kwara", "Nasarawa", "Niger", "Ondo", "Osun", "Plateau", "Sokoto", "Taraba", "Yobe", "Zamfara"];
        
        // --- DOM ELEMENTS (For quick access in verification logic) ---
        const statusPanel = document.getElementById('status-panel');
        const statusIcon = document.getElementById('status-icon');
        const statusMessage = document.getElementById('status-message');
        const logContainer = document.getElementById('log-container');
        const userIdDisplay = document.getElementById('user-id-display');
        const authStatusText = document.getElementById('auth-status-text');
        const verifyModal = document.getElementById('verify-modal');
        const verificationCard = document.getElementById('verification-card');


        // --- FIREBASE & AUDIT LOGIC ---

        /** Formats a timestamp for display. */
        function formatTime(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
        }
        
        /** Gets the Firestore path for the verification logs collection. */
        function getLogCollectionRef() {
            if (!db || !userId) return null;
            // Private data storage path: /artifacts/{appId}/users/{userId}/verification_logs
            return collection(db, 'artifacts', appId, 'users', userId, 'verification_logs');
        }

        /** Logs an event to Firestore. */
        async function logEvent(type, details, duration_seconds = null, verification_status = null) {
            const logRef = getLogCollectionRef();
            if (!logRef) return;

            try {
                const logData = {
                    timestamp: serverTimestamp(),
                    type,
                    details,
                    duration_seconds,
                    verification_status,
                };
                await addDoc(logRef, logData);
                console.log(`[Firestore Log] ${type}: ${details}`);
            } catch (error) {
                console.error("Error writing document:", error);
            }
        }

        /** Sets up real-time listener for log updates. */
        function setupLogListener() {
            const logRef = getLogCollectionRef();
            if (!logRef) return;

            // Sort logs by timestamp (descending for newest first)
            const logQuery = query(logRef, orderBy('timestamp', 'desc'));

            onSnapshot(logQuery, (snapshot) => {
                logContainer.innerHTML = ''; // Clear existing logs

                if (snapshot.empty) {
                    logContainer.innerHTML = '<p class="text-gray-400 text-sm">No activity recorded yet. Minimize the app to start tracking.</p>';
                    return;
                }

                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const time = formatTime(data.timestamp);
                    let color = 'text-gray-800';
                    let icon = 'ðŸŸ£';
                    let borderClass = 'border-indigo-400';

                    if (data.type === 'EXIT') {
                        color = 'text-red-600';
                        icon = 'ðŸ”´';
                        borderClass = 'border-red-400';
                    } else if (data.type === 'RETURN') {
                        icon = 'ðŸŸ¢';
                        if (data.verification_status === 'PASSED') {
                            color = 'text-green-600';
                            borderClass = 'border-green-400';
                        } else if (data.verification_status && data.verification_status.startsWith('FAILED')) {
                            color = 'text-red-700';
                            borderClass = 'border-red-600';
                        }
                    }

                    const durationHtml = data.duration_seconds 
                        ? `<p class="text-xs text-gray-500 mt-1">Duration Outside: <span class="font-semibold">${data.duration_seconds.toFixed(1)}s</span></p>` 
                        : '';
                    
                    const logEntry = `
                        <div class="text-sm p-2 bg-white rounded-lg shadow-sm border-l-4 ${borderClass}">
                            <span class="font-mono text-xs text-gray-400">${time}</span>
                            <p class="${color} font-medium mt-1">
                                ${icon} ${data.details}
                            </p>
                            ${durationHtml}
                        </div>
                    `;
                    logContainer.innerHTML += logEntry;
                });
            }, (error) => {
                console.error("Error listening to logs:", error);
                logContainer.innerHTML = '<p class="text-red-500 text-sm">Error loading logs.</p>';
            });
        }

        /** Handles visibility changes (user leaving/returning to the tab/app). */
        function handleVisibilityChange() {
            if (!isAuthReady || !userId || !isVerificationAttempting) {
                // Only track visibility changes when an attempt is in progress
                return;
            }

            if (document.visibilityState === 'hidden') {
                // 1. App Lost Focus (User left to go to WhatsApp, etc.)
                timeAppLostFocus = Date.now();
                
                // Update Modal UI
                updateModalStatusUI('red', '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>', 'LOST FOCUS: Logging time away...');
                verificationCard.classList.add('scan-active');

                logEvent('EXIT', `App lost focus (WA share started)`);

            } else if (document.visibilityState === 'visible') {
                // 2. App Regained Focus (User returned)
                const timeAppRegainedFocus = Date.now();
                verificationCard.classList.remove('scan-active');
                
                if (timeAppLostFocus) {
                    const durationMs = timeAppRegainedFocus - timeAppLostFocus;
                    const durationSeconds = durationMs / 1000;
                    
                    let verificationStatus;
                    let message;
                    let color;
                    let icon;
                    let vcfIdToUpdate = currentVcfId;
                    
                    // 3. Perform Verification Check
                    if (durationSeconds >= MIN_VERIFICATION_SECONDS) {
                        // Verification Success
                        verificationStatus = 'PASSED';
                        message = `VERIFICATION PASSED: Task completed in ${durationSeconds.toFixed(1)}s.`;
                        color = 'green';
                        icon = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
                        
                        // Proceed to update client-side progress if not a post-download share (vcfId 0)
                        if (vcfIdToUpdate !== 0) {
                            processSuccessfulVerification(vcfIdToUpdate);
                        } else {
                            // This is a share for tomorrow's file
                            showAlert('Share Acknowledged', `Your share has been detected and logged for the next batch drop. Thank you for preparing!`, 'share-2');
                        }

                    } else {
                        // Verification Failure (Faked completion)
                        verificationStatus = 'FAILED_QUICK_RETURN';
                        message = `VERIFICATION FAILED: Returned too quickly (${durationSeconds.toFixed(1)}s). Min time: ${MIN_VERIFICATION_SECONDS}s.`;
                        color = 'red';
                        icon = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>';

                        showAlert('Security Alert: Verification Failed', `System detected you returned too quickly (${durationSeconds.toFixed(1)}s). Please spend at least ${MIN_VERIFICATION_SECONDS} seconds on WhatsApp to complete the share task.`, 'alert-triangle');
                    }
                    
                    // 4. Log the Return Event with Results
                    logEvent('RETURN', message, durationSeconds, verificationStatus);

                    // 5. Cleanup and Reset
                    updateModalStatusUI(color, icon, message);
                    setTimeout(() => {
                        verifyModal.style.display = 'none'; // Hide modal after result is shown briefly
                        isVerificationAttempting = false;
                        currentVcfId = null;
                        renderVcfFiles(); // Re-render file list to reflect progress/failure
                    }, 1500);

                    timeAppLostFocus = null; // Reset tracker
                } else {
                    // App started in background or simply regained focus without a tracked exit
                    updateModalStatusUI('indigo', '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>', 'ACTIVE: Waiting for loss of focus...');
                    logEvent('INFO', `App active. No previous exit recorded.`);
                }
            }
        }

        /** Updates the status panel inside the verification modal. */
        function updateModalStatusUI(colorClass, iconSvg, message) {
            statusPanel.className = statusPanel.className.replace(/border-.*-300/g, `border-${colorClass}-300`);
            statusIcon.innerHTML = iconSvg;
            statusMessage.textContent = message;
            statusIcon.className = statusIcon.className.replace(/text-.*-500/g, `text-${colorClass}-500`);
            statusMessage.className = statusMessage.className.replace(/text-.*-800/g, `text-${colorClass}-800`);
            lucide.createIcons();
        }

        function setupAuthAndListeners() {
            if (document.visibilityState === 'visible') {
                updateModalStatusUI('indigo', '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>', 'ACTIVE: Ready to track focus...');
            }
            document.addEventListener('visibilitychange', handleVisibilityChange);
        }

        async function initializeFirebase() {
            try {
                setLogLevel('debug'); // Enable Firestore logging
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `User ID: ${userId}`;
                        isAuthReady = true;
                        // Setup listeners only once auth is confirmed
                        setupAuthAndListeners();
                        setupLogListener();
                    } else {
                        userId = null;
                        userIdDisplay.textContent = 'Anonymous session. Logging is limited.';
                        isAuthReady = true;
                    }
                    // Run initial status check after auth completes
                    checkUserStatus(); 
                });

            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
                userIdDisplay.textContent = 'Initialization Error.';
            }
        }
        
        // --- CLIENT-SIDE LOGIC (Updated) ---

        // Get VCF State: LOCKED_FOR_TASK, UNLOCKED_DOWNLOAD, LOCKED_FOR_TOMORROW
        function getVcfState(vcfId) {
            const downloadedHistory = JSON.parse(localStorage.getItem(DOWNLOADED_HISTORY_KEY) || '{}');
            const taskProgress = JSON.parse(localStorage.getItem(TASK_PROGRESS_KEY) || '{}');
            const progress = taskProgress[vcfId] || 0;

            if (downloadedHistory[vcfId]) {
                return { state: 'LOCKED_FOR_TOMORROW', progress };
            }
            
            if (progress >= CONFIG.shareTargetUnlock) {
                return { state: 'UNLOCKED_DOWNLOAD', progress };
            }

            return { state: 'LOCKED_FOR_TASK', progress };
        }

        // --- RENDER FUNCTIONS ---

        function renderVcfFiles() {
            const container = document.getElementById('vcf-list');
            document.getElementById('update-date').innerText = CONFIG.updateDate;

            container.innerHTML = CONFIG.vcfData.map(vcf => {
                const percentage = (vcf.count / 1000) * 100;
                const isFirst = vcf.id === 1;
                const statusColor = isFirst && vcf.status === 'Ongoing' ? 'text-red-600 font-extrabold' : 'text-slate-400 font-bold';
                const pipelineColorClass = vcf.count > 0 ? '' : 'pipeline-empty';
                
                let pipelineText = "Empty - Not yet started";
                if(vcf.count >= 1000) pipelineText = "Full - New batch pending";
                else if(vcf.count > 700) pipelineText = "Almost Full";
                else if(vcf.count > 0) pipelineText = "Filing in progress...";

                const { state, progress } = getVcfState(vcf.id);
                let buttonHTML = '';
                
                if (state === 'LOCKED_FOR_TASK') {
                    buttonHTML = `
                        <button onclick="handleShareTaskClick(${vcf.id})" ${isVerificationAttempting ? 'disabled' : ''} class="w-full ${isVerificationAttempting ? 'bg-slate-300 text-slate-500 cursor-not-allowed' : 'bg-slate-100 text-slate-500 active:bg-slate-200'} font-bold py-4 rounded-2xl flex items-center justify-center gap-3 transition-all text-sm group">
                           <i data-lucide="share-2" class="w-4 h-4 text-emerald-500 group-hover:scale-110 transition-transform"></i> 
                           SHARE TO UNLOCK (${progress}/${CONFIG.shareTargetUnlock})
                        </button>
                        <p class="text-[10px] text-center text-red-500 font-bold mt-2">Share this link to your WhatsApp Status to unlock!</p>
                    `;
                } else if (state === 'UNLOCKED_DOWNLOAD') {
                    buttonHTML = `
                        <button onclick="performDownload(${vcf.id}, '${vcf.file}')" class="block w-full bg-emerald-600 text-white font-bold py-4 rounded-2xl flex items-center justify-center gap-3 active:scale-95 transition-all text-sm shadow-lg shadow-emerald-200">
                            <i data-lucide="download" class="w-4 h-4 text-white"></i> DOWNLOAD BATCH ${vcf.id}
                        </button>
                        <a href="https://whatsapp.com/channel/0029VbC3ITpHVvTZ5btPTn0h" target="_blank" class="mt-2 block w-full text-center bg-blue-50 text-blue-700 font-bold py-2 rounded-2xl text-xs">
                            <i data-lucide="zap" class="w-3 h-3 inline-block mr-2"></i> Join WhatsApp Channel
                        </a>
                    `;
                } else if (state === 'LOCKED_FOR_TOMORROW') {
                    buttonHTML = `
                        <div class="space-y-3 pt-2">
                            <button onclick="handleShareTaskClick(0)" ${isVerificationAttempting ? 'disabled' : ''} class="w-full ${isVerificationAttempting ? 'bg-slate-300 text-slate-500 cursor-not-allowed' : 'bg-emerald-600 text-white active:scale-95'} font-bold py-4 rounded-2xl flex items-center justify-center gap-3 transition-all text-sm">
                                <i data-lucide="share-2" class="w-4 h-4 text-white"></i> SHARE TO ${CONFIG.shareTargetPostDownload} GROUPS/PEOPLE
                            </button>
                            <a href="https://whatsapp.com/channel/0029VbC3ITpHVvTZ5btPTn0h" target="_blank" class="block w-full text-center bg-blue-50 text-blue-700 font-bold py-4 rounded-2xl text-sm">
                                <i data-lucide="zap" class="w-4 h-4 inline-block mr-2"></i> Join WhatsApp Channel
                            </a>
                            <p class="text-xs text-center text-red-600/90 font-bold mt-2 leading-relaxed">
                                This file has been locked again for tomorrow's next VCF. Share to your status + ${CONFIG.shareTargetPostDownload} Groups/People to prepare.
                            </p>
                        </div>
                    `;
                }

                return `
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 space-y-4">
                        <div class="flex justify-between items-start">
                            <div class="flex gap-4 items-center">
                                <div class="bg-slate-50 ${isFirst ? 'text-emerald-600' : 'text-slate-400'} p-4 rounded-2xl">
                                    <i data-lucide="file-spreadsheet" class="w-6 h-6"></i>
                                </div>
                                <div>
                                    <h4 class="font-800 text-lg text-slate-800">Batch ${vcf.id} VCF</h4>
                                    <p class="text-[10px] uppercase tracking-widest ${statusColor}">${vcf.status}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-xs font-bold text-slate-800">${vcf.count}/1,000</p>
                                <p class="text-[9px] text-slate-400 uppercase">Capacity</p>
                            </div>
                        </div>

                        <div class="space-y-2">
                            <div class="pipeline-container">
                                <div class="pipeline-fill ${pipelineColorClass}" style="width: ${percentage}%"></div>
                            </div>
                            <div class="flex justify-between items-center">
                                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">${pipelineText}</p>
                                ${vcf.count > 0 ? `<span class="text-[9px] font-bold text-red-500">${Math.round(percentage)}%</span>` : ''}
                            </div>
                        </div>
                        ${buttonHTML}
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        // --- HANDLERS ---

        function handleShareTaskClick(vcfId) {
            if (!isAuthReady || !userId) {
                showAlert('Authentication Required', 'Please wait a moment while the system authenticates your session. Then try again.', 'refresh-cw');
                return;
            }

            // Set global tracking state
            currentVcfId = vcfId;
            isVerificationAttempting = true;
            renderVcfFiles(); // Disable other buttons

            const shareUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(CONFIG.shareText)}`;
            
            // Open WhatsApp
            window.open(shareUrl, '_blank');
            
            // Show the waiting modal and start the focus tracking process (handleVisibilityChange listens for return)
            showVerificationModal();
        }

        function showVerificationModal() {
            verifyModal.style.display = 'flex';
            document.getElementById('verification-title').innerText = "Awaiting Cross-Platform Verification";
            document.getElementById('verification-subtitle').innerText = "The system is waiting for you to complete the task and return.";
            updateModalStatusUI('red', '<svg class="w-6 h-6 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 4m0 5l-.7 4.5 1.5-1.5M4 4h5.042m-.918 21.5-4.75 4.75m0 0H7.5V11.25M10.5 11.25V7.5h-4.75M19 12h3.25m-15.5-2.75l-4.75 4.75M16.5 16.5h-4.75V19m4.75 0h-4.75M7 11v11m10-4v4"></path></svg>', 'PENDING: Waiting for loss of focus...');
            lucide.createIcons();
        }

        /** Updates the task progress locally after successful verification. */
        function processSuccessfulVerification(vcfId) {
            const taskProgress = JSON.parse(localStorage.getItem(TASK_PROGRESS_KEY) || '{}');
            let progress = taskProgress[vcfId] || 0;
            
            if (progress < CONFIG.shareTargetUnlock) {
                progress++;
                taskProgress[vcfId] = progress;
                localStorage.setItem(TASK_PROGRESS_KEY, JSON.stringify(taskProgress));
                
                if (progress >= CONFIG.shareTargetUnlock) {
                    showAlert('Task Completed!', `Batch ${vcfId} is now unlocked!`, 'check-circle');
                } else {
                    showAlert('Sharing Progress', `Share detected! You have completed ${progress} of ${CONFIG.shareTargetUnlock} shares for Batch ${vcfId}. Keep going!`, 'share-2');
                }
            }
        }

        function performDownload(vcfId, filename) {
            // 1. Add to downloaded history (locks the file for tomorrow)
            const downloadedHistory = JSON.parse(localStorage.getItem(DOWNLOADED_HISTORY_KEY) || '{}');
            downloadedHistory[vcfId] = true;
            localStorage.setItem(DOWNLOADED_HISTORY_KEY, JSON.stringify(downloadedHistory));

            // 2. Simulate file download (trigger download link)
            const link = document.createElement('a');
            link.href = filename;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // 3. Acknowledge and re-render to show locked state
            showAlert('Download Success', `Batch ${vcfId} VCF file downloaded successfully. File is now locked for the next drop.`, 'file-down');
            renderVcfFiles();
        }

        function handleGoToFiles() {
            // Show the promo modal before switching to the files tab
            document.getElementById('whatsapp-promo').style.display = 'flex';
        }

        function closePromo() {
            document.getElementById('whatsapp-promo').style.display = 'none';
            switchTab('download');
        }

        function checkUserStatus() {
            const isRegistered = localStorage.getItem(IS_REGISTERED_KEY);
            const guestView = document.getElementById('guest-view');
            const memberView = document.getElementById('member-view');
            const lockedDown = document.getElementById('download-locked');
            const unlockedDown = document.getElementById('download-unlocked');
            const statusIndicator = document.querySelector('#user-status > span:first-child');
            
            if (isRegistered) {
                guestView.classList.add('hidden');
                memberView.classList.remove('hidden');
                lockedDown.classList.add('hidden');
                unlockedDown.classList.remove('hidden');
                statusIndicator.className = "h-2 w-2 bg-emerald-500 rounded-full animate-pulse";
                authStatusText.textContent = 'Member';
                authStatusText.classList.remove('text-slate-400');
                authStatusText.classList.add('text-emerald-600');
                renderVcfFiles();
            } else {
                guestView.classList.remove('hidden');
                memberView.classList.add('hidden');
                lockedDown.classList.remove('hidden');
                unlockedDown.classList.add('hidden');
                statusIndicator.className = "h-2 w-2 bg-slate-300 rounded-full";
                authStatusText.textContent = 'Guest';
                authStatusText.classList.remove('text-emerald-600');
                authStatusText.classList.add('text-slate-400');
            }
            lucide.createIcons();
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`tab-${id}`).classList.add('active');
            const navBtn = document.querySelector(`[data-tab="${id}"]`);
            if(navBtn) navBtn.classList.add('active');
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function handleSuccess() {
            localStorage.setItem(IS_REGISTERED_KEY, 'true');
            document.getElementById('form-container').classList.add('hidden');
            document.getElementById('success-container').classList.remove('hidden');
            checkUserStatus();
        }

        function showAlert(title, message, iconName = 'info') {
            document.getElementById('alert-title').innerText = title;
            document.getElementById('alert-message').innerText = message;
            document.getElementById('alert-icon').innerHTML = `<i data-lucide="${iconName}" class="w-12 h-12 text-emerald-600 mx-auto"></i>`;
            document.getElementById('custom-alert').style.display = 'flex';
            lucide.createIcons();
        }

        function closeAlert() {
            document.getElementById('custom-alert').style.display = 'none';
        }

        // Initialize Selects
        const catSelect = document.getElementById('category-select');
        categories.forEach(c => catSelect.add(new Option(c, c)));
        const stSelect = document.getElementById('state-select');
        states.forEach(s => stSelect.add(new Option(s, s)));

        lucide.createIcons();
        initializeFirebase();

        // Initial welcome message (disclaimer)
        if(!localStorage.getItem('sawDisclaimer')) {
            setTimeout(() => {
                showAlert('Unlock Your Growth', 'Registration and a quick sharing task are required to access our community networking batches. Help us grow as you grow!', 'heart');
                localStorage.setItem('sawDisclaimer', 'true');
            }, 1000);
        }
    </script>
</body>
</html>

